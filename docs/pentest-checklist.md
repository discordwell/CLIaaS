# Penetration Testing Checklist — CLIaaS Week 5

## OWASP Top 10 Mapping

### A01:2021 — Broken Access Control
- [x] All API routes require authentication (`requireAuth`/`requireRole`)
- [x] Internal headers stripped from incoming requests (middleware)
- [x] Role hierarchy enforced (owner > admin > agent)
- [x] API key scopes validated
- [x] Row-Level Security on all PostgreSQL tables
- [x] workspace_id denormalized into all child tables
- [ ] Test: IDOR on ticket/message endpoints (change resourceId)
- [ ] Test: Cross-workspace data access

### A02:2021 — Cryptographic Failures
- [x] JWT signed with `AUTH_SECRET` (jose)
- [x] HSTS with preload enabled
- [x] Secrets encrypted at rest (SOPS + age)
- [x] API key hashed before storage (SHA-256)
- [x] MFA TOTP secrets in separate table
- [ ] Verify: SSL/TLS on database connections
- [ ] Verify: No secrets in URL query parameters

### A03:2021 — Injection
- [x] Parameterized queries via Drizzle ORM (no raw SQL)
- [x] Input parsing via `parseJsonBody` helper
- [x] CSP header blocks inline script injection
- [ ] Test: SQL injection on filter parameters
- [ ] Test: XSS via ticket subject/description

### A04:2021 — Insecure Design
- [x] Rate limiting on all API endpoints
- [x] GDPR deletion requires `confirmDelete: true`
- [x] Audit logging of all compliance operations
- [x] Immutable audit log with SHA-256 hash chain
- [ ] Review: Business logic abuse scenarios

### A05:2021 — Security Misconfiguration
- [x] Security headers on all responses
- [x] Frame-ancestors 'none' (clickjacking protection)
- [x] CORS configured for known origins
- [x] Demo mode clearly isolated (no auth bypass in production)
- [ ] Verify: Error messages don't leak internal details
- [ ] Verify: Debug endpoints disabled in production

### A06:2021 — Vulnerable Components
- [x] `pnpm audit` integrated into CI (security-audit.sh)
- [ ] Run: `pnpm audit` for critical/high CVEs
- [ ] Review: Outdated dependencies

### A07:2021 — Authentication Failures
- [x] JWT with expiration
- [x] MFA support (TOTP + backup codes)
- [x] SSO (SAML + OIDC)
- [x] API key authentication with scopes
- [x] Rate limiting on auth endpoints
- [ ] Test: Brute force login attempts
- [ ] Test: JWT token manipulation

### A08:2021 — Software and Data Integrity
- [x] Immutable audit log with hash chain verification
- [x] GDPR deletion tracked in database
- [x] Stripe webhook signature verification
- [ ] Verify: Supply chain integrity (lockfile)

### A09:2021 — Logging and Monitoring
- [x] Structured logging (Pino)
- [x] Audit logging (user + secure)
- [x] Write-ahead buffer for audit persistence
- [x] Sentry error tracking integration
- [x] Prometheus metrics endpoint
- [ ] Verify: Sensitive data not logged

### A10:2021 — Server-Side Request Forgery
- [x] Webhook endpoints validate signatures
- [x] No user-supplied URLs in server-side fetches
- [ ] Review: Integration connector URL handling

## Infrastructure Tests
- [ ] SSL certificate valid and auto-renewing
- [ ] Database connections use SSL
- [ ] Firewall rules: only ports 80/443 exposed
- [ ] systemd service runs as non-root user
- [ ] File permissions on .env and age keys (600)

## Evidence Log
| Date | Test | Result | Notes |
|------|------|--------|-------|
| | | | |
